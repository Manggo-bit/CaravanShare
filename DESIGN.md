# CaravanShare - 설계 문서

이 문서는 CaravanShare 애플리케이션의 설계 원칙 및 아키텍처를 설명합니다. 주요 목표는 초기 "나쁜 설계" 예시의 함정을 피하면서 깔끔하고 모듈화되어 있으며 테스트 가능하고 유지 관리 가능한 시스템을 만드는 것입니다.

## 1. 핵심 아키텍처 원칙

이 설계는 클린 아키텍처(Clean Architecture) 및 도메인 주도 설계(DDD) 원칙에 크게 영향을 받았습니다.

- **관심사 분리**: 코드베이스는 각각 명확하고 단일한 책임을 가진 별개의 계층(모델, 리포지토리, 서비스)으로 나뉩니다.
- **의존성 역전 원칙 (DIP)**: 상위 수준 모듈(서비스)은 하위 수준 모듈(리포지토리)에 의존하지 않으며, 둘 다 추상화에 의존합니다. 이는 서비스가 초기화 중에 리포지토리 의존성을 받는 **의존성 주입(DI)**을 통해 달성됩니다. 이는 시스템을 느슨하게 결합하고 테스트하기 쉽게 만듭니다.
- **단일 책임 원칙 (SRP)**: 각 클래스는 변경될 단 하나의 이유만 갖도록 설계됩니다.
  - `ReservationService`는 예약 생성의 조정을 처리합니다.
  - `ReservationValidator`는 예약에 대한 유효성 검사 로직을 처리합니다.
  - `ReservationRepository`는 예약에 대한 데이터 액세스를 처리합니다.

## 2. 도메인 모델

도메인은 시스템의 핵심 엔터티를 나타내는 간단한 데이터 클래스로 모델링됩니다. 이러한 모델은 이를 관리하는 서비스나 리포지토리에 대한 지식이 없는 "순수" 객체입니다.

- **User**: 게스트 또는 호스트를 나타냅니다.
- **Caravan**: 대여 가능한 카라반을 나타냅니다.
- **Reservation**: 게스트에 의한 카라반 예약을 나타냅니다.
- **Payment**: 예약에 대한 결제 거래를 나타냅니다.
- **Review**: 사용자가 카라반 또는 다른 사용자에 대해 남긴 리뷰를 나타냅니다.

## 3. 리포지토리 패턴

**리포지토리 패턴**은 데이터 계층을 추상화하는 데 사용됩니다.

- **목적**: 비즈니스 로직을 데이터 액세스 로직과 분리합니다. 서비스는 구체적인 데이터베이스 구현이 아닌 리포지토리 인터페이스와 상호 작용합니다.
- **구현**: 현재 모든 리포지토리(UserRepository, CaravanRepository, ReservationRepository)는 인메모리 사전입니다. 이는 개발 및 테스트에 충분합니다.
- **이점**: PostgreSQL 또는 NoSQL 데이터베이스와 같은 데이터베이스로 전환해야 하는 경우, 동일한 인터페이스를 따르는 새로운 리포지토리 구현을 생성하기만 하면 됩니다. 서비스 계층은 변경되지 않습니다.
- **효율성**: `ReservationRepository`는 `caravan_id`를 예약 목록에 매핑하는 사전을 사용하여 특정 카라반에 대한 모든 예약의 효율적인(O(1)) 조회를 제공하며, 이는 예약 충돌 유효성 검사 로직에 중요합니다.

## 4. 서비스 계층 및 비즈니스 로직

- **ReservationService**: 이 서비스는 유스케이스 오케스트레이터 역할을 합니다. `create_reservation` 메서드는 다음과 같은 명확한 단계 시퀀스를 따릅니다:
  1. 필요한 엔터티(User, Caravan)를 가져옵니다.
  2. 유효성 검사를 `ReservationValidator`에 위임합니다.
  3. 계산(예: `total_price`)을 수행합니다.
  4. `Reservation` 엔터티를 생성합니다.
  5. `ReservationRepository`를 사용하여 엔터티를 영구 저장합니다.
- **ReservationValidator**: 예약 생성과 관련된 모든 복잡한 유효성 검사 로직은 이 클래스 내에 캡슐화됩니다. 이는 유효성 검사 규칙을 명시적이고 독립적으로 테스트 가능하며, 주요 예약 생성 흐름에 영향을 주지 않고 쉽게 수정할 수 있도록 합니다.

## 5. 오류 처리

`src/exceptions/`에 사용자 정의 예외 계층이 정의되어 있습니다.

- **기본 예외**: `ReservationError`는 모든 예약 관련 문제의 기본 역할을 합니다.
- **특정 예외**: `InvalidDateError`, `CaravanNotAvailableError`, `BookingConflictError`와 같은 클래스는 무엇이 잘못되었는지에 대한 명확하고 구체적인 정보를 제공합니다. 이를 통해 애플리케이션의 진입점(예: REST API)은 특정 오류를 포착하고 적절한 HTTP 상태 코드 및 메시지를 반환할 수 있습니다.

설계에 대한 이러한 구조화된 접근 방식은 애플리케이션이 견고하고 확장 가능하며 개발자가 이해하고 확장하기 쉽도록 보장합니다.